<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Home - Brand</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/bs-theme-overrides.css">
    <link rel="stylesheet" href="assets/css/Drag-Drop-File-Input-Upload.css">
    <link rel="stylesheet" href="assets/css/Team-Horizontal-icons.css">
    <link rel="stylesheet" href="assets/css/Team-Horizontal-images.css">
    <link rel="stylesheet" href="assets/css/untitled.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body id="page-top" data-bs-spy="scroll" data-bs-target="#mainNav" data-bs-offset="72">
    <nav class="navbar navbar-expand-lg fixed-top bg-secondary text-uppercase navbar-light" id="mainNav" style="position: static;">
        <div class="container"><a class="navbar-brand" href="#page-top"><img id="logo" hred="log" src="assets/img/logo.png" width="130" height="100"></a><button data-bs-toggle="collapse" data-bs-target="#navbarResponsive" class="navbar-toggler text-white bg-primary navbar-toggler-right text-uppercase rounded" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><i class="fa fa-bars"></i></button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded" href="#portfolio">PortAfolio</a></li>
                    <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded" href="#nosotros">Nosotros</a></li>
                    <li class="nav-item mx-0 mx-lg-0 py-2"><a class="nav-link portfolio-item" href="#modal-Registrer" data-bs-toggle="modal">Registrarse</a></li>
                    <li class="nav-item mx-0 mx-lg-1"><button class="btn btn-primary py-3 px-0 px-lg-3 rounded" data-bs-toggle="modal" role="Button">INICIAR SESIÓN</button></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container"></div>
    <br>
    <br>
        
    <h1 class="text-center">
        Usuarios asignados a la tarea:
        <span  id="title" style="color: rgb(238,153,27);">
        </span></h1>
    <br>
    <div class="container">

        <div class="table-responsive" id="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Nombre</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Aquí se llenarán las filas de la tabla -->
                </tbody>
            </table>
        </div>
    </div>

    <br>
    <div class="container"></div>
    <footer class="text-center footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-5 mb-lg-0">
                    <h4 class="text-uppercase mb-4">Ubicación</h4>
                    <p>kilómetro 12 Vía a Puerto López, Vda. Barcelona, Villavicencio, Meta.<br>Teléfono: (608) 6616800</p>
                </div>
                <div class="col-md-4 mb-5 mb-lg-0">
                    <h4 class="text-uppercase">Redes Sociales</h4>
                    <ul class="list-inline">
                        <li class="list-inline-item"><a class="btn btn-outline-light text-center btn-social rounded-circle" role="button" href="#"><i class="fa fa-facebook fa-fw"></i></a></li>
                        <li class="list-inline-item"><a class="btn btn-outline-light text-center btn-social rounded-circle" role="button" href="#"><i class="fa fa-google-plus fa-fw"></i></a></li>
                        <li class="list-inline-item"><a class="btn btn-outline-light text-center btn-social rounded-circle" role="button" href="#"><i class="fa fa-twitter fa-fw"></i></a></li>
                        <li class="list-inline-item"><a class="btn btn-outline-light text-center btn-social rounded-circle" role="button" href="#"><i class="fa fa-dribbble fa-fw"></i></a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h4 class="text-uppercase mb-4">Unillanos</h4>
                    <p class="lead mb-0"><span>Institución en la cual nace este proyecto, conclusión del curso programación Go.</span></p>
                </div>
            </div>
        </div>
    </footer>
    <div class="text-center text-white copyright py-4">
        <div class="container"><small>Copyright ©&nbsp;Workhub 2023</small></div>
    </div>


    
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/freelancer.js"></script>
    <script>

        // Capturar el parámetro 'id' de la URL
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        var idTask = getParameterByName('id_task');
        var title = getParameterByName('name_task');

        // Llenar el título de la página
        const titleElement = document.getElementById('title');
        titleElement.textContent = title;

        var idUser = localStorage.getItem('idUser');

        // //validar parametro id_group esta en el localstorage en el array de grupos arrayIdGroups
        // var arrayIdGroups = localStorage.getItem('arrayIdGroups');
        // var arrayIdGroupsParsed = JSON.parse(arrayIdGroups);

        // var idGroupInt = parseInt(idGroup);

        // if (arrayIdGroupsParsed.includes(idGroupInt)) {
        //     console.log('El usuario tiene permisos para ver este grupo');
        // } else {
        //     console.log('El usuario no tiene permisos para ver este grupo');
        //     window.location.href = 'forbidden.html';
        // }


        // Hacer la solicitud Fetch
        fetch('https://localhost:8085/api/task-user/get-by-task/' + idTask  )
            .then(response => response.json())
            .then(data => {
                // Manipular el DOM y llenar la tabla
                const tableBody = document.getElementById('table-body');

                //validar si esta vacio
                console.log(data.length);
                if (data.length == 0) {
                    const containerTable = document.getElementById('table-container');
                    containerTable.innerHTML = '<h3 class="text-center">No hay usuarios en este grupo</h3>';


                }else{
                    data.forEach(user => {
                        const row = document.createElement('tr');
    
                        const idCell = document.createElement('td');
                        idCell.textContent = user.user.id;

                        const fullnameCell = document.createElement('td');
                        fullnameCell.textContent = user.user.first_name + ' ' + user.user.last_name;

                        const emailCell = document.createElement('td');
                        emailCell.textContent = user.user.email;
                        
                        row.appendChild(idCell);
                        row.appendChild(fullnameCell);
                        row.appendChild(emailCell);
    
                        tableBody.appendChild(row);
                    });



                }
            }).catch(error => console.error('Error fetching data:', error));

    </script>
    <script>
        function confirmDelete(user_id_group) {
            swal.fire({
                title: '¿Estás seguro?',
                text: 'El usuario será eliminado del grupo',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteUserTaskGroup(user_id_group);
                }
            });
        }
    
        function deleteUserTaskGroup(id_user_group) {
            fetch('https://localhost:8085/api/group-user/delete/' + id_user_group, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    swal.fire({
                        title: '¡Eliminado!',
                        text: 'El usuario ha sido eliminado del grupo',
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        updateTable();
                    });
                } else {
                    swal.fire({
                        title: 'Error',
                        text: 'No se pudo eliminar el usuario del grupo',
                        icon: 'error',
                        confirmButtonText: 'Aceptar'
                    });
                }
            }).catch(error => {
                console.error('Error deleting user from group:', error);
                swal.fire({
                    title: 'Error',
                    text: 'No se pudo eliminar el usuario del grupo',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            });
        }

        function updateTable() {
        // Aquí puedes realizar la lógica necesaria para volver a cargar la información en la tabla
        // Por ejemplo, volver a realizar la solicitud Fetch y actualizar la tabla con los nuevos datos
        // ...

        // En este ejemplo, simplemente recargamos la página después de un breve retraso
        setTimeout(() => {
            window.location.reload();
        }, 100);
    }
    </script>
    <script>
        function showAssigneUserGroupModal(groupId) {
            //traer todos los usuarios
            fetch('https://localhost:8085/api/user/get-all')
                .then(response => response.json())
                .then(data => {
                    // Manipular el DOM y llenar la tabla
                    //lista de usuarios
                    let arrayUsers = [];
                    data.forEach(user => {
                        arrayUsers.push({
                            id: user.id,
                            fullname: user.first_name + ' ' + user.last_name
                        });
                    });
                    Swal.fire({
                        title: 'Asignar Usuario a Grupo',
                        html:
                            `<select id="assigneUserGroup" class="swal2-input">` +
                            `<option value="" disabled selected>Selecciona un usuario</option>` +
                            arrayUsers.map(user => `<option value="${user.id}">${user.fullname}</option>`) +
                            `</select>`,
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Asignar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Si se confirma, hacer la solicitud Fetch para asignar el usuario al grupo
                            const assigneUserGroup = document.getElementById('assigneUserGroup').value;
                            assigneUserToGroup(assigneUserGroup, groupId);
                        }
                    });

                })
            .catch(error => console.error('Error fetching data:', error));         

        }

        function assigneUserToGroup(assigneUserGroup, assigneGroup) {
            // Hacer la solicitud Fetch para asignar el usuario al grupo
            assigneUserGroup = parseInt(assigneUserGroup);
            fetch(`https://localhost:8085/api/group-user/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: assigneUserGroup,
                    group_id: assigneGroup
                }),
            })
            .then(response => {
                if (response.ok) {
                    // Asignación exitosa, recargar la página o actualizar la tabla
                    updateTable();
                } else {
                    console.error('Error al intentar asignar el usuario al grupo');
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Error al intentar asignar el usuario al grupo',
                    });
                }
            })
            .catch(error => console.error('Error fetching data:', error));
        }   

    </script>
    
</body>

</html>